version: "3.9"

services:
  # ===============================
  # üêò PostgreSQL Databases
  # ===============================
  events-postgres:
    image: postgres:15-alpine
    container_name: events-postgres
    environment:
      POSTGRES_DB: ${EVENTS_DB_NAME}
      POSTGRES_USER: ${EVENTS_DB_USER}
      POSTGRES_PASSWORD: ${EVENTS_DB_PASSWORD}
    ports:
      - "${EVENTS_DB_PORT}:5432"
    volumes:
      - events_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${EVENTS_DB_USER} -d ${EVENTS_DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - eventy-network
  
  keycloak-postgres:
    image: postgres:15-alpine
    container_name: keycloak-postgres
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password 
    ports:
      - "5430:5432"
    volumes:
      - keycloak_data:/var/lib/postgresql/data
    networks:
      - eventy-network 
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  users-postgres:
    image: postgres:15-alpine
    container_name: users-postgres
    environment:
      POSTGRES_DB: ${USERS_DB_NAME}
      POSTGRES_USER: ${USERS_DB_USER}
      POSTGRES_PASSWORD: ${USERS_DB_PASSWORD}
    ports:
      - "${USERS_DB_PORT}:5432"
    volumes:
      - users_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USERS_DB_USER} -d ${USERS_DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - eventy-network

  tickets-postgres:
    image: postgres:15-alpine
    container_name: tickets-postgres
    environment:
      POSTGRES_DB: ${TICKETS_DB_NAME}
      POSTGRES_USER: ${TICKETS_DB_USER}
      POSTGRES_PASSWORD: ${TICKETS_DB_PASSWORD}
    ports:
      - "${TICKETS_DB_PORT}:5432"
    volumes:
      - tickets_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TICKETS_DB_USER} -d ${TICKETS_DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - eventy-network

  transactions-postgres:
    image: postgres:15-alpine
    container_name: transactions-postgres
    environment:
      POSTGRES_DB: ${TRANSACTIONS_DB_NAME}
      POSTGRES_USER: ${TRANSACTIONS_DB_USER}
      POSTGRES_PASSWORD: ${TRANSACTIONS_DB_PASSWORD}
    ports:
      - "${TRANSACTIONS_DB_PORT}:5432"
    volumes:
      - transactions_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TRANSACTIONS_DB_USER} -d ${TRANSACTIONS_DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - eventy-network

  interactions-postgres:
    image: postgres:15-alpine
    container_name: interactions-postgres
    environment:
      POSTGRES_DB: ${INTERACTIONS_DB_NAME}
      POSTGRES_USER: ${INTERACTIONS_DB_USER}
      POSTGRES_PASSWORD: ${INTERACTIONS_DB_PASSWORD}
    ports:
      - "${INTERACTIONS_DB_PORT}:5432"
    volumes:
      - interactions_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${INTERACTIONS_DB_USER} -d ${INTERACTIONS_DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - eventy-network

  # ===============================
  # üß© Microservices
  # ===============================
  eventy-eureka-service:
    build:
      context: ./eventy-eureka-service 
      dockerfile: Dockerfile
    container_name: eventy-eureka-service
    ports:
      - "${EUREKA_SERVICE_PORT}:8761" # Utilise la variable du .env
    environment:
      SERVER_PORT: 8761
      SPRING_APPLICATION_NAME: eventy-eureka-service
    networks:
      - eventy-network
    restart: unless-stopped

  keycloak:
    build:
      context: ./eventy-keycloak-service 
      dockerfile: Dockerfile
    container_name: keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/${POSTGRES_DB} # Utilise les variables BDD
      KC_DB_USERNAME: ${POSTGRES_USER}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HTTP_PORT: 8090
      
      # Configuration pour le SPI UserSyncEventListener
      USER_SERVICE_URL: http://eventy-users-service:8083 # Point d'acc√®s interne
      KEYCLOAK_SYNC_SECRET: ${KEYCLOAK_SYNC_SECRET}
      
    ports:
      - "${KEYCLOAK_PORT}:8090" # Utilise la variable du .env
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    networks:
      - eventy-network
    restart: unless-stopped

  eventy-events-service:
    build:
      context: ./eventy-events-service
      dockerfile: Dockerfile
    container_name: eventy-events-service
    environment:
      # CONFIGURATION EUREKA CLIENT
      EUREKA_DEFAULT_ZONE: http://eventy-eureka-service:8761/eureka
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://events-postgres:5432/${EVENTS_DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${EVENTS_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${EVENTS_DB_PASSWORD}
      SERVER_PORT: ${EVENTS_SERVICE_PORT}
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_INTERNAL_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_TARGET_REALM}
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/${KEYCLOAK_TARGET_REALM}
    ports:
      - "${EVENTS_SERVICE_PORT}:8082"
    depends_on:
      events-postgres:
        condition: service_healthy
      eventy-eureka-service:
        condition: service_started
    networks:
      - eventy-network
    restart: unless-stopped

  eventy-users-service:
    build:
      context: ./eventy-users-service
      dockerfile: Dockerfile
    container_name: eventy-users-service
    environment:
      DATABASE_URL: jdbc:postgresql://users-postgres:5432/${USERS_DB_NAME}
      JWT_ISSUER_URI: http://keycloak:8090/realms/eventy-realm
      # CONFIGURATION EUREKA CLIENT
      EUREKA_DEFAULT_ZONE: http://eventy-eureka-service:8761/eureka
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://users-postgres:5432/${USERS_DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${USERS_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${USERS_DB_PASSWORD}
      SERVER_PORT: ${USERS_SERVICE_PORT}
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_INTERNAL_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_TARGET_REALM}
      KEYCLOAK_ADMIN_REALM: ${KEYCLOAK_ADMIN_REALM}
      KEYCLOAK_ADMIN_CLIENT_ID: ${KEYCLOAK_ADMIN_CLIENT_ID}
      KEYCLOAK_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_USERNAME}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KEYCLOAK_SYNC_SECRET: ${KEYCLOAK_SYNC_SECRET}
    ports:
      - "${USERS_SERVICE_PORT}:8083"
    depends_on:
      users-postgres:
        condition: service_healthy
      eventy-eureka-service:
        condition: service_started
      keycloak:
        condition: service_started
    networks:
      - eventy-network
    restart: unless-stopped

  eventy-tickets-service:
    build:
      context: ./eventy-tickets-service
      dockerfile: Dockerfile
    container_name: eventy-tickets-service
    environment:
      # CONFIGURATION EUREKA CLIENT
      EUREKA_DEFAULT_ZONE: http://eventy-eureka-service:8761/eureka
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://tickets-postgres:5432/${TICKETS_DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${TICKETS_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${TICKETS_DB_PASSWORD}
      SERVER_PORT: ${TICKETS_SERVICE_PORT}
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/eventy-realm
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_INTERNAL_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_TARGET_REALM}
    ports:
      - "${TICKETS_SERVICE_PORT}:8084"
    depends_on:
      tickets-postgres:
        condition: service_healthy
      eventy-eureka-service:
        condition: service_started
    networks:
      - eventy-network
    restart: unless-stopped

  eventy-transactions-service:
    build:
      context: ./eventy-transactions-service
      dockerfile: Dockerfile
    container_name: eventy-transactions-service
    environment:
      # CONFIGURATION EUREKA CLIENT
      EUREKA_DEFAULT_ZONE: http://eventy-eureka-service:8761/eureka
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://transactions-postgres:5432/${TRANSACTIONS_DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${TRANSACTIONS_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${TRANSACTIONS_DB_PASSWORD}
      SERVER_PORT: ${TRANSACTIONS_SERVICE_PORT}
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_INTERNAL_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_TARGET_REALM}
      KEYCLOAKK_ISSUER_URI: http://keycloak:8090/realms/eventy-realm
      STRIPE_API_KEY: ${STRIPE_SECRET_KEY}
    ports:
      - "${TRANSACTIONS_SERVICE_PORT}:8085"
    depends_on:
      transactions-postgres:
        condition: service_healthy
      eventy-eureka-service:
        condition: service_started
    networks:
      - eventy-network
    restart: unless-stopped

  eventy-interactions-service:
    build:
      context: ./eventy-interactions-service
      dockerfile: Dockerfile
    container_name: eventy-interactions-service
    environment:
      # CONFIGURATION EUREKA CLIENT
      EUREKA_DEFAULT_ZONE: http://eventy-eureka-service:8761/eureka
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://interactions-postgres:5432/${INTERACTIONS_DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${INTERACTIONS_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${INTERACTIONS_DB_PASSWORD}
      SERVER_PORT: ${INTERACTIONS_SERVICE_PORT}
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_INTERNAL_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_TARGET_REALM}
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/${KEYCLOAK_TARGET_REALM}
    ports:
      - "${INTERACTIONS_SERVICE_PORT}:8086"
    depends_on:
      interactions-postgres:
        condition: service_healthy
      eventy-eureka-service:
        condition: service_started
    networks:
      - eventy-network
    restart: unless-stopped

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    environment:
      # CONFIGURATION EUREKA CLIENT
      EUREKA_DEFAULT_ZONE: http://eventy-eureka-service:8761/eureka
      SPRING_PROFILES_ACTIVE: docker
      SERVER_PORT: ${GATEWAY_PORT}
    ports:
      - "${GATEWAY_PORT}:8080"
    depends_on:
      eventy-eureka-service:
        condition: service_started
      eventy-events-service:
        condition: service_started
      eventy-users-service:
        condition: service_started
      eventy-tickets-service:
        condition: service_started
      eventy-transactions-service:
        condition: service_started
      eventy-interactions-service:
        condition: service_started
    networks:
      - eventy-network
    restart: unless-stopped

# ===============================
  # üì® Event Streaming (Kafka)
  # ===============================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "22181:2181"
    networks:
      - eventy-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Configuration pour l'acc√®s interne (Docker) et externe (Host)
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - eventy-network

# ===============================
# Volumes and Network
# ===============================
volumes:
  events_data:
  users_data:
  tickets_data:
  transactions_data:
  interactions_data:
  keycloak_data:
networks:
  eventy-network:
    driver: bridge
